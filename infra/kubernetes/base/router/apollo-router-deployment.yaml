apiVersion: v1
kind: ConfigMap
metadata:
  name: apollo-router-config
  namespace: neotool-web
data:
  router.yaml: |
    supergraph:
      path: /graphql

    cors:
      allow_any_origin: true

    include_subgraph_errors:
      all: true

    headers:
      all:
        request:
          - propagate:
              named: authorization
          - propagate:
              named: x-request-id
          - propagate:
              named: traceparent
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: router
  namespace: neotool-web
spec:
  replicas: 2
  selector:
    matchLabels:
      app: router
  template:
    metadata:
      labels:
        app: router
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: router
          image: ghcr.io/apollographql/router:v2.7.0
          command:
            - --supergraph
            - /dist/supergraph.graphql
            - --config
            - /dist/router.yaml
          ports:
            - containerPort: 4000
              name: graphql
            - containerPort: 9090
              name: metrics
          env:
            - name: APOLLO_ROUTER_LISTEN_ADDRESS
              value: "0.0.0.0:4000"
            - name: APOLLO_ROUTER_TELEMETRY_METRICS_PROMETHEUS_ENABLED
              value: "true"
            - name: APOLLO_ROUTER_TELEMETRY_METRICS_PROMETHEUS_LISTEN
              value: "0.0.0.0:9090"
            - name: APOLLO_ROUTER_TELEMETRY_METRICS_PROMETHEUS_PATH
              value: "/metrics"
          volumeMounts:
            - name: supergraph
              mountPath: /dist/supergraph.graphql
              subPath: supergraph.graphql
            - name: router-config
              mountPath: /dist/router.yaml
              subPath: router.yaml
          livenessProbe:
            httpGet:
              path: /health
              port: 8088
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8088
            initialDelaySeconds: 10
            periodSeconds: 5
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: supergraph
          configMap:
            name: supergraph-config
        - name: router-config
          configMap:
            name: apollo-router-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: supergraph-config
  namespace: neotool-web
data:
  supergraph.graphql: |
    # Supergraph schema will be provided here
    # This should be generated from the subgraph schemas
---
apiVersion: v1
kind: Service
metadata:
  name: router
  namespace: neotool-web
spec:
  type: ClusterIP
  ports:
    - port: 4000
      targetPort: 4000
      name: graphql
    - port: 9090
      targetPort: 9090
      name: metrics
  selector:
    app: router

