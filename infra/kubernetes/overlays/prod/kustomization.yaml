apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: default

resources:
  - ../../base

# Production environment patches
patches:
  # Use Cloudflare R2 storage class for production
  - target:
      kind: PersistentVolumeClaim
    patch: |-
      - op: replace
        path: /spec/storageClassName
        value: cloudflare-r2

  # Increase replicas for production
  - target:
      kind: Deployment
      name: pgbouncer
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  - target:
      kind: Deployment
      name: nextjs
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 5

  - target:
      kind: Deployment
      name: router
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  - target:
      kind: StatefulSet
      name: postgres
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  - target:
      kind: StatefulSet
      name: kafka
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  # Increase resource limits for production
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 2Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 2000m

# Common labels
commonLabels:
  environment: production

