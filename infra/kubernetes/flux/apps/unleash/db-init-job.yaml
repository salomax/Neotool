---
# Job to initialize Unleash database and user (idempotent)
apiVersion: batch/v1
kind: Job
metadata:
  name: unleash-db-init
  namespace: production
  labels:
    app: unleash
    component: db-init
  annotations:
    # This annotation prevents the job from being automatically deleted
    # Remove it manually after verifying the database was created
    "helm.sh/hook": "pre-install,pre-upgrade"
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "before-hook-creation"
spec:
  ttlSecondsAfterFinished: 86400  # Keep job for 24 hours
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: unleash
        component: db-init
    spec:
      serviceAccountName: default
      restartPolicy: OnFailure
      containers:
        - name: db-init
          image: postgres:18.1
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Initializing Unleash database..."
              
              # Get database credentials from environment
              UNLEASH_USER="${UNLEASH_USER:-unleash_app}"
              UNLEASH_PASSWORD="${UNLEASH_PASSWORD}"
              UNLEASH_DB="${UNLEASH_DB:-unleash}"
              POSTGRES_HOST="${POSTGRES_HOST:-postgres-headless.production.svc.cluster.local}"
              POSTGRES_PORT="${POSTGRES_PORT:-5432}"
              POSTGRES_ADMIN_USER="${POSTGRES_ADMIN_USER}"
              POSTGRES_ADMIN_PASSWORD="${POSTGRES_ADMIN_PASSWORD}"
              
              if [ -z "$UNLEASH_PASSWORD" ]; then
                echo "Error: UNLEASH_PASSWORD not set"
                exit 1
              fi
              
              if [ -z "$POSTGRES_ADMIN_USER" ] || [ -z "$POSTGRES_ADMIN_PASSWORD" ]; then
                echo "Error: POSTGRES_ADMIN_USER and POSTGRES_ADMIN_PASSWORD must be set"
                exit 1
              fi
              
              export PGPASSWORD="$POSTGRES_ADMIN_PASSWORD"
              
              # Wait for PostgreSQL to be ready
              echo "Waiting for PostgreSQL to be ready..."
              until pg_isready -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -U "$POSTGRES_ADMIN_USER"; do
                echo "PostgreSQL is unavailable - sleeping"
                sleep 2
              done
              
              echo "PostgreSQL is ready"
              
              # Create user if it doesn't exist (idempotent)
              echo "Creating user $UNLEASH_USER if it doesn't exist..."
              psql -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -U "$POSTGRES_ADMIN_USER" -d postgres <<EOF
              DO \$\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '$UNLEASH_USER') THEN
                  CREATE ROLE $UNLEASH_USER LOGIN PASSWORD '$UNLEASH_PASSWORD';
                  RAISE NOTICE 'User $UNLEASH_USER created';
                ELSE
                  RAISE NOTICE 'User $UNLEASH_USER already exists';
                END IF;
              END \$\$;
              EOF
              
              # Create database if it doesn't exist (idempotent)
              echo "Creating database $UNLEASH_DB if it doesn't exist..."
              psql -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -U "$POSTGRES_ADMIN_USER" -d postgres <<EOF
              SELECT 'CREATE DATABASE $UNLEASH_DB OWNER $UNLEASH_USER'
              WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '$UNLEASH_DB')\gexec
              EOF
              
              # Grant privileges
              echo "Granting privileges..."
              psql -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -U "$POSTGRES_ADMIN_USER" -d postgres <<EOF
              GRANT CONNECT, TEMP, CREATE ON DATABASE $UNLEASH_DB TO $UNLEASH_USER;
              ALTER DATABASE $UNLEASH_DB OWNER TO $UNLEASH_USER;
              EOF
              
              echo "Unleash database initialization completed successfully"
          env:
            - name: UNLEASH_USER
              valueFrom:
                secretKeyRef:
                  name: unleash-credentials
                  key: UNLEASH_USER
            - name: UNLEASH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: unleash-credentials
                  key: UNLEASH_PASSWORD
            - name: UNLEASH_DB
              valueFrom:
                secretKeyRef:
                  name: unleash-credentials
                  key: UNLEASH_DB
            - name: POSTGRES_HOST
              value: "postgres-headless.production.svc.cluster.local"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_USER
            - name: POSTGRES_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_PASSWORD
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
