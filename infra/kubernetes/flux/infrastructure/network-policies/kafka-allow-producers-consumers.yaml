---
# Network Policy: Kafka - Allow connections from producers and consumers
#
# This policy allows applications (services, web) to connect to Kafka as
# producers and consumers. Kafka also needs to communicate with itself
# for clustering (if multiple brokers).
#
# Security benefit: Only authorized applications can produce/consume messages.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kafka-allow-producers-consumers
  namespace: production
  labels:
    app: kafka
    component: streaming
spec:
  podSelector:
    matchLabels:
      app: kafka
  policyTypes:
  - Ingress
  ingress:
  # Services (Kotlin microservices) can connect as producers/consumers
  - from:
    - podSelector:
        matchLabels:
          component: service
    ports:
    - protocol: TCP
      port: 9092  # Kafka client port
  # Web components (Next.js, Apollo Router) can connect
  - from:
    - podSelector:
        matchLabels:
          component: web
    ports:
    - protocol: TCP
      port: 9092
  # Kafka brokers can communicate with each other (for clustering)
  - from:
    - podSelector:
        matchLabels:
          app: kafka
    ports:
    - protocol: TCP
      port: 9092  # Client port
    - protocol: TCP
      port: 9093  # Controller port (KRaft mode)
  # Allow health checks from kubelet
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 9092
    - protocol: TCP
      port: 9093
