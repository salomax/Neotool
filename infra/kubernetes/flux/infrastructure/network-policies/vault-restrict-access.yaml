---
# Network Policy: Vault - Restrict access to External Secrets Operator only
#
# This policy ensures that only the External Secrets Operator can access Vault.
# Applications should never directly access Vault - they use Kubernetes Secrets
# that are synced by External Secrets Operator.
#
# Security benefit: Reduces attack surface - even if an app is compromised,
# it cannot directly access Vault secrets.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vault-restrict-access
  namespace: production
  labels:
    app.kubernetes.io/name: vault
    component: infrastructure
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vault
      # Helm chart uses app.kubernetes.io/name: vault by default
  policyTypes:
  - Ingress
  ingress:
  # Only External Secrets Operator can access Vault
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: external-secrets
          # Helm chart uses app.kubernetes.io/name: external-secrets by default
    ports:
    - protocol: TCP
      port: 8200
  # Vault pods can communicate with each other (for HA/clustering)
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: vault
    ports:
    - protocol: TCP
      port: 8200
  # Allow health checks from kubelet
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 8200
