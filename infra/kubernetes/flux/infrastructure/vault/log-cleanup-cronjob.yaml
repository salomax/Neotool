---
# CronJob to clean up Vault audit logs older than 30 days
# Runs daily at 2 AM UTC
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vault-log-cleanup
  namespace: production
  labels:
    app: vault
    component: log-cleanup
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid  # Don't run multiple jobs at once
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: vault
            component: log-cleanup
        spec:
          serviceAccountName: vault-log-cleanup
          containers:
          - name: log-cleanup
            image: hashicorp/vault:1.21.1
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Starting Vault log cleanup..."
              
              # Calculate cutoff date (30 days ago)
              CUTOFF_DATE=$(date -u -d '30 days ago' '+%Y-%m-%d')
              echo "Removing Vault audit logs older than: $CUTOFF_DATE"
              
              # Get Vault pod name
              VAULT_POD=$(kubectl get pod -n production -l app.kubernetes.io/name=vault -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
              
              if [ -z "$VAULT_POD" ]; then
                echo "Error: Vault pod not found"
                exit 1
              fi
              
              echo "Found Vault pod: $VAULT_POD"
              
              # Clean up logs in Vault pod
              # Vault audit logs are typically in /vault/logs/ or /vault/audit/
              # Using mtime +30 to delete files older than 30 days
              kubectl exec -n production "$VAULT_POD" -- sh -c "
                set -e
                DELETED_COUNT=0
                
                # Clean up logs in /vault/logs/ (if exists)
                if [ -d /vault/logs ]; then
                  COUNT=\$(find /vault/logs -type f -name '*.log' -mtime +30 | wc -l)
                  if [ \"\$COUNT\" -gt 0 ]; then
                    find /vault/logs -type f -name '*.log' -mtime +30 -delete
                    DELETED_COUNT=\$((DELETED_COUNT + COUNT))
                    echo \"Deleted \$COUNT log file(s) from /vault/logs/\"
                  else
                    echo \"No old logs found in /vault/logs/\"
                  fi
                fi
                
                # Clean up logs in /vault/audit/ (if exists)
                if [ -d /vault/audit ]; then
                  COUNT=\$(find /vault/audit -type f -name '*.log' -mtime +30 | wc -l)
                  if [ \"\$COUNT\" -gt 0 ]; then
                    find /vault/audit -type f -name '*.log' -mtime +30 -delete
                    DELETED_COUNT=\$((DELETED_COUNT + COUNT))
                    echo \"Deleted \$COUNT log file(s) from /vault/audit/\"
                  else
                    echo \"No old logs found in /vault/audit/\"
                  fi
                fi
                
                # Also clean up any .json audit files
                if [ -d /vault/audit ]; then
                  COUNT=\$(find /vault/audit -type f -name '*.json' -mtime +30 | wc -l)
                  if [ \"\$COUNT\" -gt 0 ]; then
                    find /vault/audit -type f -name '*.json' -mtime +30 -delete
                    DELETED_COUNT=\$((DELETED_COUNT + COUNT))
                    echo \"Deleted \$COUNT JSON audit file(s) from /vault/audit/\"
                  fi
                fi
                
                echo \"Total files deleted: \$DELETED_COUNT\"
              " || {
                echo "Error: Failed to clean up Vault logs"
                exit 1
              }
              
              echo "Vault log cleanup completed successfully"
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
          restartPolicy: OnFailure
---
# ServiceAccount for Vault log cleanup CronJob
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-log-cleanup
  namespace: production
  labels:
    app: vault
    component: log-cleanup
---
# Role for accessing Vault pod
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-log-cleanup
  namespace: production
  labels:
    app: vault
    component: log-cleanup
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
---
# RoleBinding for ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-log-cleanup
  namespace: production
  labels:
    app: vault
    component: log-cleanup
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-log-cleanup
subjects:
- kind: ServiceAccount
  name: vault-log-cleanup
  namespace: production
