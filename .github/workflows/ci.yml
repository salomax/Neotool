name: CI

on:
  pull_request:
    branches: ['**']
    paths-ignore:
      - '**.md'
      - 'docs/**'

concurrency:
  group: ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  CI: true
  TESTCONTAINERS_RYUK_DISABLED: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      kotlin: ${{ steps.filter.outputs.kotlin }}
      kotlin-common: ${{ steps.filter.outputs.kotlin-common }}
      kotlin-security: ${{ steps.filter.outputs.kotlin-security }}
      kotlin-assets: ${{ steps.filter.outputs.kotlin-assets }}
      kotlin-financialdata: ${{ steps.filter.outputs.kotlin-financialdata }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            kotlin:
              - 'service/kotlin/**'
            kotlin-common:
              - 'service/kotlin/common/**'
              - 'service/kotlin/build.gradle.kts'
              - 'service/kotlin/settings.gradle.kts'
              - 'service/kotlin/gradle/**'
            kotlin-security:
              - 'service/kotlin/security/**'
            kotlin-assets:
              - 'service/kotlin/assets/**'
            kotlin-financialdata:
              - 'service/kotlin/financialdata/**'
            web:
              - 'web/**'

  test-kotlin:
    needs: changes
    if: needs.changes.outputs.kotlin == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: common
            run-integration: false
          - service: security
            run-integration: true
          - service: assets
            run-integration: true
          - service: financialdata
            run-integration: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: true

      - name: Check if service changed
        id: should-run
        run: |
          SERVICE="${{ matrix.service }}"
          COMMON_CHANGED="${{ needs.changes.outputs.kotlin-common }}"
          SERVICE_CHANGED="${{ needs.changes.outputs[format('kotlin-{0}', matrix.service)] }}"

          if [[ "$COMMON_CHANGED" == "true" || "$SERVICE_CHANGED" == "true" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Run ktlint
        if: steps.should-run.outputs.run == 'true'
        working-directory: ./service/kotlin
        run: ./gradlew :${{ matrix.service }}:ktlintCheck --no-daemon

      - name: Run unit tests
        if: steps.should-run.outputs.run == 'true'
        working-directory: ./service/kotlin
        run: ./gradlew :${{ matrix.service }}:test --no-daemon

      - name: Run integration tests
        if: steps.should-run.outputs.run == 'true' && matrix.run-integration
        working-directory: ./service/kotlin
        run: ./gradlew :${{ matrix.service }}:testIntegration --no-daemon

      - name: Verify coverage
        if: steps.should-run.outputs.run == 'true'
        working-directory: ./service/kotlin
        run: ./gradlew :${{ matrix.service }}:koverXmlReport :${{ matrix.service }}:koverVerify --no-daemon

      - name: Upload test results
        if: always() && steps.should-run.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: service/kotlin/${{ matrix.service }}/build/reports/tests/
          retention-days: 7

  test-web:
    needs: changes
    if: needs.changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 10.16.0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: web/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm run typecheck

      - name: Lint
        run: pnpm run lint --max-warnings=0

      - name: Unit tests
        run: pnpm run test:unit

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

  ci-success:
    runs-on: ubuntu-latest
    needs: [test-kotlin, test-web, security-scan]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.test-kotlin.result }}" == "failure" ]] || \
             [[ "${{ needs.test-web.result }}" == "failure" ]] || \
             [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All jobs passed or were skipped"
