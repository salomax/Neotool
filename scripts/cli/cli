#!/usr/bin/env bash

set -euo pipefail

# Neotool CLI
# 
# Unified command-line interface for neotool project management tasks.
# Routes commands to individual command scripts in commands/ directory.

# Get script directory and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
COMMANDS_DIR="$SCRIPT_DIR/commands"

# Source shared utilities
# shellcheck source=utils.sh
source "$SCRIPT_DIR/utils.sh"

# Show help text
show_help() {
    cat << EOF
$(log "Neotool CLI" "$BRIGHT")

Usage: $0 <command> [options]

Commands:
  $(log "graphql" "$GREEN") <subcommand>
    Manage GraphQL schema synchronization and supergraph generation.
    Subcommands: sync, validate, generate, all
    Run '$0 graphql --help' for more information.

  $(log "validate" "$GREEN") [options]
    Run all validations (web and services).
    Includes: lint, typecheck, test/testIntegration, and coverage.
    Options: --web, --service [name], --skip-coverage
    Run '$0 validate --help' for more information.

  $(log "kafka" "$GREEN") [options] <command>
    Manage Kafka topics and consumer groups.
    Commands: --topic [name], --consumer-group [name], --reset-offsets
    Run '$0 kafka --help' for more information.

  $(log "upstream" "$GREEN") <subcommand>
    Manage .gitattributes for files that should use "ours" merge strategy.
    Subcommands: init, add, list, remove
    Run '$0 upstream --help' for more information.

  $(log "vault" "$GREEN") <subcommand>
    Manage HashiCorp Vault secrets for JWT keys.
    Subcommands: create-secret
    Run '$0 vault --help' for more information.

  $(log "service" "$GREEN") <subcommand>
    Manage service registration with Security Service.
    Subcommands: register
    Run '$0 service --help' for more information.

  $(log "flags" "$GREEN") <subcommand>
    Manage Unleash feature flags.
    Subcommands: import, list, enable, disable
    Run '$0 flags --help' for more information.

  $(log "pgbouncer" "$GREEN") <subcommand>
    Manage PgBouncer configuration and credentials.
    Subcommands: credential-md5
    Run '$0 pgbouncer --help' for more information.

Options:
  -v, --version    Check system requirements (Node.js, Docker, JVM)

Examples:
  $0 graphql sync
  $0 graphql generate
  $0 validate
  $0 validate --web
  $0 validate --service security
  $0 kafka --topic
  $0 kafka --topic swapi.people.v1
  $0 kafka --consumer-group
  $0 kafka --reset-offsets --group swapi-people-consumer-group --topic swapi.people.v1 --to-earliest --execute
  $0 upstream add web/public/favicon.ico
  $0 upstream list
  $0 vault create-secret kid-1
  $0 vault create-secret kid-2 --key-bits 2048
  $0 service register service-x
  $0 service register service-x --permissions "asset:read,asset:list"
  $0 flags list
  $0 flags import infra/unleash/flags.yaml
  $0 flags enable security/login/enabled
  $0 flags disable assistant/enable --env production
  $0 pgbouncer credential-md5 neotool neotool
  $0 pgbouncer credential-md5 --from-env
  $0 --version

For more information about a specific command, run it with --help.
EOF
}

# Execute a command script
execute_command() {
    local command_name="$1"
    shift 2>/dev/null || true
    local command_script="$COMMANDS_DIR/$command_name.sh"
    
    if [[ ! -f "$command_script" ]]; then
        log_error "Error: Command script not found: $command_script"
        exit 1
    fi
    
    if [[ ! -x "$command_script" ]]; then
        log_error "Error: Command script is not executable: $command_script"
        exit 1
    fi
    
    "$command_script" "$@"
}

# Main command router
main() {
    local command="${1:-}"
    
    # Handle version flags before processing command
    if [[ "$command" == "-v" || "$command" == "--version" ]]; then
        execute_command "version"
        exit $?
    fi
    
    # Shift to remove command from arguments
    shift 2>/dev/null || true
    
    # Handle graphql command (has subcommands)
    if [[ "$command" == "graphql" ]]; then
        execute_command "graphql" "$@"
        exit $?
    fi
    
    # Handle kafka command (has subcommands)
    if [[ "$command" == "kafka" ]]; then
        execute_command "kafka" "$@"
        exit $?
    fi
    
    # Handle upstream command (has subcommands)
    if [[ "$command" == "upstream" ]]; then
        execute_command "upstream" "$@"
        exit $?
    fi
    
    # Handle vault command (has subcommands)
    if [[ "$command" == "vault" ]]; then
        execute_command "vault" "$@"
        exit $?
    fi
    
    # Handle service command (has subcommands)
    if [[ "$command" == "service" ]]; then
        execute_command "service" "$@"
        exit $?
    fi
    
    # Handle flags command (has subcommands)
    if [[ "$command" == "flags" ]]; then
        execute_command "flags" "$@"
        exit $?
    fi
    
    # Handle pgbouncer command (has subcommands)
    if [[ "$command" == "pgbouncer" ]]; then
        execute_command "pgbouncer" "$@"
        exit $?
    fi
    
    case "$command" in
        version|validate)
            execute_command "$command" "$@"
            ;;
        help|--help|-h|"")
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"

