# Task Breakdown for Authorization Access Checks Feature
# This file breaks down the feature implementation into small, manageable tasks organized by phase

phases:
  - name: Business Documentation
    status: completed
    tasks:
      - id: doc-001
        description: Create authorization.feature file with comprehensive Gherkin scenarios
        status: completed
        files:
          - docs/03-features/security/authorization/authorization.feature
      - id: doc-002
        description: Create authorization.memory.yml with business rules and validations
        status: completed
        files:
          - docs/03-features/security/authorization/authorization.memory.yml
      - id: doc-003
        description: Create authorization.tasks.yml task breakdown
        status: completed
        files:
          - docs/03-features/security/authorization/authorization.tasks.yml

  - name: Domain
    status: completed
    tasks:
      - id: domain-001
        description: Create database migration for RBAC tables (users, roles, permissions, role_assignments)
        status: pending
        dependencies: []
        files:
          - service/kotlin/security/src/main/resources/db/migration/V*__create_rbac_tables.sql
        notes: |
          Tables needed:
          - users (if not exists)
          - roles
          - permissions
          - role_assignments (user_id, role_id, scope_type, scope_id, valid_from, valid_until)
          - role_permissions (role_id, permission_id)

      - id: domain-002
        description: Create database migration for groups and group memberships
        status: pending
        dependencies: []
        files:
          - service/kotlin/security/src/main/resources/db/migration/V*__create_group_tables.sql
        notes: |
          Tables needed:
          - groups
          - group_memberships (user_id, group_id, membership_type, valid_until)
          - group_role_assignments (group_id, role_id, scope_type, scope_id, valid_from, valid_until)

      - id: domain-003
        description: Create database migration for ABAC policies
        status: pending
        dependencies: []
        files:
          - service/kotlin/security/src/main/resources/db/migration/V*__create_abac_tables.sql
        notes: |
          Tables needed:
          - abac_policies (id, name, effect, condition, version, is_active, created_at, updated_at)
          - abac_policy_versions (for versioning support)

      - id: domain-004
        description: Create database migration for audit logs
        status: pending
        dependencies: []
        files:
          - service/kotlin/security/src/main/resources/db/migration/V*__create_audit_log_tables.sql
        notes: |
          Tables needed:
          - authorization_audit_logs (user_id, groups, roles, requested_action, resource_type, resource_id, rbac_result, abac_result, final_decision, timestamp, metadata)

      - id: domain-005
        description: Create indexes for performance optimization
        status: pending
        dependencies: [domain-001, domain-002, domain-003]
        files:
          - service/kotlin/security/src/main/resources/db/migration/V*__create_authorization_indexes.sql
        notes: |
          Indexes needed:
          - role_assignments(user_id, role_id)
          - role_assignments(user_id, scope_type, scope_id)
          - group_memberships(user_id, group_id)
          - group_role_assignments(group_id, role_id)
          - authorization_audit_logs(user_id, timestamp)
          - authorization_audit_logs(resource_type, resource_id)

      - id: domain-006
        description: Implement JPA entities for RBAC (User, Role, Permission, RoleAssignment)
        status: pending
        dependencies: [domain-001]
        files:
          - service/kotlin/security/src/main/kotlin/.../domain/rbac/User.kt
          - service/kotlin/security/src/main/kotlin/.../domain/rbac/Role.kt
          - service/kotlin/security/src/main/kotlin/.../domain/rbac/Permission.kt
          - service/kotlin/security/src/main/kotlin/.../domain/rbac/RoleAssignment.kt
        notes: Follow entity patterns from docs/04-patterns/backend-patterns/entity-pattern.md

      - id: domain-007
        description: Implement JPA entities for groups (Group, GroupMembership, GroupRoleAssignment)
        status: pending
        dependencies: [domain-002]
        files:
          - service/kotlin/security/src/main/kotlin/.../domain/rbac/Group.kt
          - service/kotlin/security/src/main/kotlin/.../domain/rbac/GroupMembership.kt
          - service/kotlin/security/src/main/kotlin/.../domain/rbac/GroupRoleAssignment.kt

      - id: domain-008
        description: Implement JPA entity for ABAC policies
        status: pending
        dependencies: [domain-003]
        files:
          - service/kotlin/security/src/main/kotlin/.../domain/abac/AbacPolicy.kt
          - service/kotlin/security/src/main/kotlin/.../domain/abac/AbacPolicyVersion.kt

      - id: domain-009
        description: Implement JPA entity for audit logs
        status: pending
        dependencies: [domain-004]
        files:
          - service/kotlin/security/src/main/kotlin/.../domain/audit/AuthorizationAuditLog.kt

      - id: domain-010
        description: Review domain code until no issues (lint, type safety, patterns)
        status: pending
        dependencies: [domain-006, domain-007, domain-008, domain-009]
        notes: Loop until all issues resolved

  - name: Backend Service (API Sync)
    status: pending
    tasks:
      - id: backend-001
        description: Implement Repository layer for RBAC (RoleRepository, PermissionRepository, RoleAssignmentRepository)
        status: pending
        dependencies: [domain-010]
        files:
          - service/kotlin/security/src/main/kotlin/.../repository/RoleRepository.kt
          - service/kotlin/security/src/main/kotlin/.../repository/PermissionRepository.kt
          - service/kotlin/security/src/main/kotlin/.../repository/RoleAssignmentRepository.kt
        notes: Use Micronaut Data repositories

      - id: backend-002
        description: Implement Repository layer for groups (GroupRepository, GroupMembershipRepository, GroupRoleAssignmentRepository)
        status: pending
        dependencies: [domain-010]
        files:
          - service/kotlin/security/src/main/kotlin/.../repository/GroupRepository.kt
          - service/kotlin/security/src/main/kotlin/.../repository/GroupMembershipRepository.kt
          - service/kotlin/security/src/main/kotlin/.../repository/GroupRoleAssignmentRepository.kt

      - id: backend-003
        description: Implement Repository layer for ABAC (AbacPolicyRepository)
        status: pending
        dependencies: [domain-010]
        files:
          - service/kotlin/security/src/main/kotlin/.../repository/AbacPolicyRepository.kt

      - id: backend-004
        description: Implement Repository layer for audit logs (AuthorizationAuditLogRepository)
        status: pending
        dependencies: [domain-010]
        files:
          - service/kotlin/security/src/main/kotlin/.../repository/AuthorizationAuditLogRepository.kt

      - id: backend-005
        description: Implement RBAC Service layer (RoleService, PermissionService, AuthorizationService)
        status: pending
        dependencies: [backend-001, backend-002]
        files:
          - service/kotlin/security/src/main/kotlin/.../service/RoleService.kt
          - service/kotlin/security/src/main/kotlin/.../service/PermissionService.kt
          - service/kotlin/security/src/main/kotlin/.../service/AuthorizationService.kt
        notes: |
          AuthorizationService should:
          - Check RBAC permissions (direct and inherited)
          - Handle scoped permissions
          - Check temporary access validity
          - Cache results for performance

      - id: backend-006
        description: Implement ABAC Service layer (AbacPolicyService, AbacEvaluationService)
        status: pending
        dependencies: [backend-003]
        files:
          - service/kotlin/security/src/main/kotlin/.../service/AbacPolicyService.kt
          - service/kotlin/security/src/main/kotlin/.../service/AbacEvaluationService.kt
        notes: |
          AbacEvaluationService should:
          - Evaluate policies with subject, resource, context attributes
          - Support AND/OR logical conditions
          - Handle allow/deny effects
          - Support explicit deny override

      - id: backend-007
        description: Implement Hybrid Authorization Service (combines RBAC + ABAC)
        status: pending
        dependencies: [backend-005, backend-006]
        files:
          - service/kotlin/security/src/main/kotlin/.../service/HybridAuthorizationService.kt
        notes: |
          Should:
          - Evaluate RBAC first (short-circuit if denies)
          - Evaluate ABAC if RBAC allows
          - Handle explicit deny override
          - Generate audit logs

      - id: backend-008
        description: Implement Audit Service for authorization decisions
        status: pending
        dependencies: [backend-004]
        files:
          - service/kotlin/security/src/main/kotlin/.../service/AuthorizationAuditService.kt
        notes: Log all authorization decisions with full context

      - id: backend-009
        description: Implement caching layer for authorization checks
        status: pending
        dependencies: [backend-007]
        files:
          - service/kotlin/security/src/main/kotlin/.../service/AuthorizationCacheService.kt
        notes: |
          Cache:
          - User roles and permissions
          - Group memberships
          - Policy evaluation results
          - Invalidate on role/permission changes

      - id: backend-010
        description: Implement GraphQL resolvers for authorization checks
        status: pending
        dependencies: [backend-007, backend-008]
        files:
          - service/kotlin/security/src/main/kotlin/.../graphql/resolver/AuthorizationResolver.kt
        notes: |
          Queries:
          - checkPermission(userId, permission, resourceId, scope)
          - getUserPermissions(userId)
          - getUserRoles(userId)

      - id: backend-011
        description: Implement GraphQL mappers for authorization types
        status: pending
        dependencies: [backend-010]
        files:
          - service/kotlin/security/src/main/kotlin/.../graphql/mapper/AuthorizationMapper.kt

      - id: backend-012
        description: Implement GraphQL configuration (Factory, wiring)
        status: pending
        dependencies: [backend-011]
        files:
          - service/kotlin/security/src/main/kotlin/.../graphql/config/AuthorizationGraphQLConfig.kt

      - id: backend-013
        description: Review backend code until no issues (lint, type safety, patterns)
        status: pending
        dependencies: [backend-012]
        notes: Loop until all issues resolved

  - name: Backend Tests
    status: pending
    tasks:
      - id: test-001
        description: Implement unit tests for RBAC Service
        status: pending
        dependencies: [backend-005]
        files:
          - service/kotlin/security/src/test/kotlin/.../service/RoleServiceTest.kt
          - service/kotlin/security/src/test/kotlin/.../service/PermissionServiceTest.kt
          - service/kotlin/security/src/test/kotlin/.../service/AuthorizationServiceTest.kt

      - id: test-002
        description: Implement unit tests for ABAC Service
        status: pending
        dependencies: [backend-006]
        files:
          - service/kotlin/security/src/test/kotlin/.../service/AbacPolicyServiceTest.kt
          - service/kotlin/security/src/test/kotlin/.../service/AbacEvaluationServiceTest.kt

      - id: test-003
        description: Implement unit tests for Hybrid Authorization Service
        status: pending
        dependencies: [backend-007]
        files:
          - service/kotlin/security/src/test/kotlin/.../service/HybridAuthorizationServiceTest.kt

      - id: test-004
        description: Implement integration tests for authorization checks
        status: pending
        dependencies: [backend-013]
        files:
          - service/kotlin/security/src/test/kotlin/.../integration/AuthorizationIntegrationTest.kt
        notes: Test full flow from GraphQL to database

      - id: test-005
        description: Run tests until success (loop)
        status: pending
        dependencies: [test-001, test-002, test-003, test-004]
        notes: Fix any failing tests

  - name: Review Backend code
    status: pending
    tasks:
      - id: review-001
        description: Run coverage and lint until success (loop)
        status: pending
        dependencies: [test-005]
        notes: Ensure coverage meets standards

  - name: Contract
    status: pending
    tasks:
      - id: contract-001
        description: Sync and Generate supergraphql (./neotool graphql sync and generate)
        status: pending
        dependencies: [review-001]
        files:
          - contracts/graphql/subgraphs/security/*.graphqls
          - contracts/graphql/supergraph/*.graphql

      - id: contract-002
        description: Run web codegen
        status: pending
        dependencies: [contract-001]
        notes: Generate TypeScript types for frontend

  - name: Front End
    status: pending
    tasks:
      - id: frontend-001
        description: Implement authorization check hooks (useAuthorization, usePermission)
        status: pending
        dependencies: [contract-002]
        files:
          - web/src/shared/hooks/useAuthorization.ts
          - web/src/shared/hooks/usePermission.ts
        notes: Follow hook patterns from docs/04-patterns/frontend-patterns/hook-pattern.md

      - id: frontend-002
        description: Implement GraphQL queries for authorization checks
        status: pending
        dependencies: [contract-002]
        files:
          - web/src/shared/graphql/queries/authorization.graphql
        notes: Follow GraphQL patterns from docs/04-patterns/frontend-patterns/graphql-pattern.md

      - id: frontend-003
        description: Implement authorization context provider
        status: pending
        dependencies: [frontend-001]
        files:
          - web/src/shared/contexts/AuthorizationContext.tsx
        notes: Provide authorization state to components

      - id: frontend-004
        description: Implement access denied UI component
        status: pending
        dependencies: [frontend-003]
        files:
          - web/src/shared/components/authorization/AccessDenied.tsx
        notes: Show user-friendly access denied messages

      - id: frontend-005
        description: Implement authorization guard component (ProtectedRoute, PermissionGuard)
        status: pending
        dependencies: [frontend-003]
        files:
          - web/src/shared/components/authorization/ProtectedRoute.tsx
          - web/src/shared/components/authorization/PermissionGuard.tsx
        notes: Protect routes and components based on permissions

      - id: frontend-006
        description: Review frontend code until no issues (lint, type safety, patterns)
        status: pending
        dependencies: [frontend-005]
        notes: Loop until all issues resolved

  - name: Front End tests
    status: pending
    tasks:
      - id: frontend-test-001
        description: Implement unit tests for authorization hooks
        status: pending
        dependencies: [frontend-001]
        files:
          - web/src/shared/hooks/__tests__/useAuthorization.test.ts
          - web/src/shared/hooks/__tests__/usePermission.test.ts

      - id: frontend-test-002
        description: Implement component tests for authorization components
        status: pending
        dependencies: [frontend-005]
        files:
          - web/src/shared/components/authorization/__tests__/AccessDenied.test.tsx
          - web/src/shared/components/authorization/__tests__/ProtectedRoute.test.tsx
          - web/src/shared/components/authorization/__tests__/PermissionGuard.test.tsx

      - id: frontend-test-003
        description: Run tests until success (loop)
        status: pending
        dependencies: [frontend-test-001, frontend-test-002]
        notes: Fix any failing tests

  - name: Review Frontend code
    status: pending
    tasks:
      - id: frontend-review-001
        description: Run coverage and lint until success (loop)
        status: pending
        dependencies: [frontend-test-003]
        notes: Ensure coverage meets standards

