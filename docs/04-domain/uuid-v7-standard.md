---
title: UUID v7 Pattern
type: pattern
category: backend
status: current
version: 1.0.0
tags: [uuid, database, domain, entity, pattern]
ai_optimized: true
search_keywords: [uuid, uuidv7, primary-key, domain, entity, database]
related:
  - 05-standards/database-standards/schema-standards.md
  - 04-patterns/backend-patterns/domain-entity-conversion.md
  - 11-validation/code-review-checklist.md
---

# UUID v7 Pattern

> **Purpose**: Standard pattern for using UUID v7 (timestamp-based) as primary keys in domain entities.

## Overview

UUID v7 is a timestamp-based UUID format that provides:
- **Sortability**: UUIDs are naturally sortable by creation time
- **Better index locality**: Improves database index performance
- **Time-based queries**: Can extract timestamp from UUID for time-based operations
- **Uniqueness**: Still maintains global uniqueness

## Rule: Use UUID v7 for All Domain Entity Primary Keys

**Rule**: All domain entities with UUID primary keys MUST use UUID v7, generated by the database.

**Rationale**:
- Consistent UUID format across the system
- Better database performance (index locality)
- Natural sorting by creation time
- Time-based querying capabilities

## Database Migration Pattern

### 1. PostgreSQL Version Requirements

**PostgreSQL 18+**: `uuidv7()` is built-in and available without any extension.

**PostgreSQL < 18**: Requires `pg_uuidv7` extension to be installed.

### 2. Extension Installation (PostgreSQL < 18 only)

For PostgreSQL versions before 18, migrations MUST install the `pg_uuidv7` extension:

```sql
-- Set search path to schema
SET search_path TO {schema}, public;

-- Install uuidv7 extension if not exists (PostgreSQL < 18 only)
-- Note: PostgreSQL 18+ has uuidv7() built-in, no extension needed
CREATE EXTENSION IF NOT EXISTS pg_uuidv7;
```

**For PostgreSQL 18+**: Skip the extension installation step entirely. The `uuidv7()` function is built-in.

### 3. Table Definition

Tables with UUID primary keys MUST use `uuidv7()` as the default:

```sql
-- ✅ Correct
CREATE TABLE IF NOT EXISTS {schema}.{table} (
    id UUID PRIMARY KEY DEFAULT uuidv7(),
    -- other columns
);

-- ❌ Incorrect - Missing DEFAULT uuidv7()
CREATE TABLE IF NOT EXISTS {schema}.{table} (
    id UUID PRIMARY KEY,
    -- other columns
);

-- ❌ Incorrect - Using gen_random_uuid() (UUID v4)
CREATE TABLE IF NOT EXISTS {schema}.{table} (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    -- other columns
);
```

### 3. Altering Existing Tables

When adding UUID columns to existing tables:

```sql
-- ✅ Correct
ALTER TABLE {schema}.{table} 
    ALTER COLUMN id SET DEFAULT uuidv7();

-- ❌ Incorrect
ALTER TABLE {schema}.{table} 
    ADD COLUMN id UUID DEFAULT gen_random_uuid();
```

## Entity Pattern

### Entity Definition

Entities with UUID primary keys MUST:
1. Use nullable `UUID?` type
2. Use `@GeneratedValue(strategy = GenerationType.IDENTITY)`
3. Have `null` as default value (let database generate)
4. Use `BaseEntity<UUID?>` (nullable type parameter)

```kotlin
// ✅ Correct
@Entity
@Table(name = "users", schema = "security")
open class UserEntity(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(columnDefinition = "uuid")
    override val id: UUID? = null,  // Nullable, no default UUID generation
    @Column(nullable = false, unique = true)
    open val email: String,
    // ... other fields
) : BaseEntity<UUID?>(id) {
    fun toDomain(): User {
        return User(
            id = this.id,
            email = this.email,
            // ... other fields
        )
    }
}

// ❌ Incorrect - Application generates UUID (v4)
@Entity
@Table(name = "users", schema = "security")
open class UserEntity(
    @Id
    @Column(columnDefinition = "uuid")
    override val id: UUID = UUID.randomUUID(),  // Application generates v4
    // ...
) : BaseEntity<UUID>(id)

// ❌ Incorrect - Missing @GeneratedValue
@Entity
@Table(name = "users", schema = "security")
open class UserEntity(
    @Id
    @Column(columnDefinition = "uuid")
    override val id: UUID? = null,  // Missing @GeneratedValue
    // ...
) : BaseEntity<UUID?>(id)
```

## Domain Object Pattern

### Domain Object Definition

Domain objects MUST:
1. Use nullable `UUID?` for IDs
2. Pass `null` to entity when creating new instances
3. Preserve existing ID when converting from entity

```kotlin
// ✅ Correct
data class User(
    val id: UUID? = null,
    val email: String,
    val displayName: String? = null,
    // ... other fields
) {
    fun toEntity(): UserEntity {
        return UserEntity(
            id = this.id,  // Pass null for new users, let DB generate v7
            email = this.email,
            displayName = this.displayName,
            // ... other fields
        )
    }
}

// ❌ Incorrect - Generates UUID in application
data class User(
    val id: UUID? = null,
    val email: String,
) {
    fun toEntity(): UserEntity {
        return UserEntity(
            id = this.id ?: UUID.randomUUID(),  // Application generates v4
            email = this.email,
        )
    }
}
```

## Service Layer Pattern

### Creating New Entities

Services MUST NOT generate UUIDs in application code:

```kotlin
// ✅ Correct - Let database generate UUID v7
@Transactional
fun createUser(email: String, name: String): User {
    val userDomain = User(
        id = null,  // Explicitly null for new entity
        email = email,
        displayName = name,
    )
    val entity = userDomain.toEntity()
    val saved = userRepository.save(entity)
    return saved.toDomain()
}

// ❌ Incorrect - Application generates UUID
@Transactional
fun createUser(email: String, name: String): User {
    val userDomain = User(
        id = UUID.randomUUID(),  // Application generates v4
        email = email,
        displayName = name,
    )
    val entity = userDomain.toEntity()
    val saved = userRepository.save(entity)
    return saved.toDomain()
}
```

## Migration Checklist

When creating or modifying tables with UUID primary keys:

- [ ] **PostgreSQL version checked**: If PostgreSQL < 18, extension installed: `CREATE EXTENSION IF NOT EXISTS pg_uuidv7;`
- [ ] **PostgreSQL 18+**: No extension needed, `uuidv7()` is built-in
- [ ] Default set: `DEFAULT uuidv7()`
- [ ] Entity uses nullable `UUID?`
- [ ] Entity uses `@GeneratedValue(strategy = GenerationType.IDENTITY)`
- [ ] Entity default is `null` (not `UUID.randomUUID()`)
- [ ] Domain object passes `null` for new instances
- [ ] Service layer doesn't generate UUIDs

## Verification

### Database Verification

Check that tables use `uuidv7()`:

```sql
SELECT 
    table_name,
    column_name,
    column_default
FROM information_schema.columns
WHERE table_schema = 'security'
  AND column_name = 'id'
  AND data_type = 'uuid';
```

Expected result: `column_default` should be `uuidv7()`.

### Code Verification

1. **Entity**: Check for `@GeneratedValue(strategy = GenerationType.IDENTITY)` and `UUID? = null`
2. **Domain**: Check that `toEntity()` passes `id` directly (not generates new UUID)
3. **Service**: Check that no `UUID.randomUUID()` calls when creating entities
4. **Migration**: Check for `DEFAULT uuidv7()` in table definitions

## Exceptions

### When NOT to Use UUID v7

1. **Legacy Systems**: Existing tables with UUID v4 can remain (but new tables must use v7)
2. **External IDs**: IDs that come from external systems (keep as-is)
3. **Non-Primary Keys**: Foreign keys and other UUID columns can use v4 if needed (but prefer v7)

### Migration Strategy for Existing Tables

For existing tables with UUID v4:
- Keep existing records with v4 UUIDs
- Change default to `uuidv7()` for new records
- Document the mixed UUID versions if needed

## Related Patterns

- [Domain-Entity Conversion Pattern](./domain-entity-conversion.md)
- [Database Standards](../05-standards/database-standards/schema-standards.md)
- [Code Review Checklist](../11-validation/code-review-checklist.md)

## PostgreSQL Version Notes

### PostgreSQL 18+

PostgreSQL 18 includes `uuidv7()` as a built-in function. No extension installation is required:

```sql
-- ✅ Correct for PostgreSQL 18+
SET search_path TO {schema}, public;

-- No extension needed, uuidv7() is built-in
CREATE TABLE IF NOT EXISTS {schema}.{table} (
    id UUID PRIMARY KEY DEFAULT uuidv7(),
    -- other columns
);
```

### PostgreSQL < 18

For PostgreSQL versions before 18, the `pg_uuidv7` extension must be installed:

```sql
-- ✅ Correct for PostgreSQL < 18
SET search_path TO {schema}, public;

-- Install extension for PostgreSQL < 18
CREATE EXTENSION IF NOT EXISTS pg_uuidv7;

CREATE TABLE IF NOT EXISTS {schema}.{table} (
    id UUID PRIMARY KEY DEFAULT uuidv7(),
    -- other columns
);
```

## References

- [RFC 4122 Draft - UUID Version 7](https://datatracker.ietf.org/doc/html/draft-ietf-uuidrev-rfc4122bis)
- [PostgreSQL pg_uuidv7 Extension](https://github.com/pg-uuidv7/pg_uuidv7) (for PostgreSQL < 18)
- [PostgreSQL 18 Release Notes](https://www.postgresql.org/docs/18/release-18.html) - uuidv7() built-in

