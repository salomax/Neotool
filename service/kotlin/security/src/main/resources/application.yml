micronaut:
  application:
    name: neotool-security-service
  executors:
    blocking:
      virtual: true
  server:
    port: 8080
    thread-selection: blocking
    cors:
      enabled: true
      configurations:
        web:
          allowed-origins:
            - http://localhost:3000
            - http://127.0.0.1:3000
          allowed-methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          allowed-headers:
            - "*"
          allow-credentials: true
          max-age: 3600
  security:
    enabled: true

  # Micrometer Configuration for Metrics Collection
  metrics:
    enabled: true
    export:
      prometheus:
        enabled: true
        step: PT15S
  observation:
    enabled: true

# JWT Configuration
jwt:
  # Algorithm: RS256 (RSA-SHA256) - only supported algorithm
  # Can be set via JWT_ALGORITHM environment variable
  algorithm: ${JWT_ALGORITHM:RS256}
  # RSA private key path (PEM format) - required for RS256 signing
  # Can be set via JWT_PRIVATE_KEY_PATH environment variable
  private-key-path: ${JWT_PRIVATE_KEY_PATH:}
  # RSA public key path (PEM format) - required for RS256 validation
  # Can be set via JWT_PUBLIC_KEY_PATH environment variable
  public-key-path: ${JWT_PUBLIC_KEY_PATH:}
  # Inline RSA private key (PEM or base64) - alternative to private-key-path
  # Can be set via JWT_PRIVATE_KEY environment variable
  private-key: ${JWT_PRIVATE_KEY:}
  # Inline RSA public key (PEM or base64) - alternative to public-key-path
  # Can be set via JWT_PUBLIC_KEY environment variable
  public-key: ${JWT_PUBLIC_KEY:}
  # Key ID for JWKS (default: kid-1)
  # Can be set via JWT_KEY_ID environment variable
  key-id: ${JWT_KEY_ID:kid-1}
  # Enable JWKS endpoint (default: true)
  # Can be set via JWT_JWKS_ENABLED environment variable
  jwks-enabled: ${JWT_JWKS_ENABLED:true}
  # JWKS URL for validators (not used by issuer service)
  # Can be set via JWT_JWKS_URL environment variable
  jwks-url: ${JWT_JWKS_URL:}
  # Access token expiration in seconds (default: 900 = 15 minutes)
  access-token-expiration-seconds: ${JWT_ACCESS_TOKEN_EXPIRATION_SECONDS:900}
  # Refresh token expiration in seconds (default: 604800 = 7 days)
  refresh-token-expiration-seconds: ${JWT_REFRESH_TOKEN_EXPIRATION_SECONDS:604800}

# Vault Configuration
vault:
  # Enable Vault integration
  # Can be set via VAULT_ENABLED environment variable
  enabled: ${VAULT_ENABLED:false}
  # Vault server address
  # Can be set via VAULT_ADDRESS environment variable
  address: ${VAULT_ADDRESS:}
  # Vault authentication token (should be provided via environment variable in production)
  # Can be set via VAULT_TOKEN environment variable
  token: ${VAULT_TOKEN:}
  # Secret path prefix in Vault (keys stored at {secret-path}/{keyId}/private, {secret-path}/{keyId}/public)
  # Can be set via VAULT_SECRET_PATH environment variable
  secret-path: ${VAULT_SECRET_PATH:secret/jwt/keys}
  # KV secrets engine version (default: 2)
  # Can be set via VAULT_ENGINE_VERSION environment variable
  engine-version: ${VAULT_ENGINE_VERSION:2}
  # Connection timeout in milliseconds (default: 5000)
  # Can be set via VAULT_CONNECTION_TIMEOUT environment variable
  connection-timeout: ${VAULT_CONNECTION_TIMEOUT:5000}
  # Read timeout in milliseconds (default: 5000)
  # Can be set via VAULT_READ_TIMEOUT environment variable
  read-timeout: ${VAULT_READ_TIMEOUT:5000}

# Email Configuration
email:
  # From email address (used in email templates)
  # Can be set via EMAIL_FROM environment variable
  from: ${EMAIL_FROM:noreply@neotool.com}
  # Frontend URL for generating reset links
  # Can be set via FRONTEND_URL environment variable
  frontend-url: ${FRONTEND_URL:http://localhost:3000}
  # Delivery: mock (default, logs to console) or comms (via Apollo Router to Comms service).
  # For comms, also set graphql.router.url and security.service.id/secret (see docs/09-security/service-to-service-auth.md).
  delivery: ${EMAIL_DELIVERY:mock}

# Email verification (signup flow)
app:
  verification:
    enabled: ${EMAIL_VERIFICATION_ENABLED:true}
    code-expiration-hours: ${VERIFICATION_CODE_EXPIRATION_HOURS:8}
    max-attempts: ${VERIFICATION_MAX_ATTEMPTS:5}
    resend-rate-limit-per-hour: ${VERIFICATION_RESEND_RATE_LIMIT:3}
    unverified-account-ttl-days: ${UNVERIFIED_ACCOUNT_TTL_DAYS:7}
    grandfather-existing-users: ${GRANDFATHER_EXISTING_USERS:true}
    grandfather-cutoff-date: ${GRANDFATHER_CUTOFF_DATE:2026-02-15T00:00:00Z}
    verification-email-template: "auth.verify-email"
    deletion-warning-template: "auth.account-deletion-warning"
    verification-link-base-url: ${APP_BASE_URL:http://localhost:3000}/verify-email-link

# GraphQL Router (for service-to-service: e.g. requestEmailSend via Comms).
# Required when email.delivery=comms.
graphql:
  router:
    url: ${GRAPHQL_ROUTER_URL:}

# Service principal credentials (for outbound service-to-service calls, e.g. to Apollo Router).
# Required when email.delivery=comms. Register via: neotool service register neotool-security-service --permissions ... --output-env
security:
  service:
    url: ${SECURITY_SERVICE_URL:}
    id: ${SECURITY_SERVICE_ID:}
    secret: ${SECURITY_SERVICE_SECRET:}

# OAuth Configuration
oauth:
  google:
    # Google OAuth client ID (required for Google sign-in)
    client-id: ${GOOGLE_CLIENT_ID:}
    issuer: ${GOOGLE_ISSUER:}

datasources:
  default:
    url: jdbc:postgresql://${POSTGRES_HOST:localhost}:${POSTGRES_PORT:6432}/${POSTGRES_DB:neotool_db}
    driverClassName: org.postgresql.Driver
    username: ${POSTGRES_USER:neotool}
    password: ${POSTGRES_PASSWORD:neotool}
    dialect: POSTGRES
    # HikariCP Connection Pool Configuration
    # See: https://github.com/brettwooldridge/HikariCP#configuration-knobs-baby
    hikari:
      # Pool sizing
      maximum-pool-size: ${HIKARI_MAX_POOL_SIZE:20}
      minimum-idle: ${HIKARI_MIN_IDLE:5}
      
      # Connection lifecycle
      connection-timeout: ${HIKARI_CONNECTION_TIMEOUT:30000} # 30 seconds
      idle-timeout: ${HIKARI_IDLE_TIMEOUT:600000} # 10 minutes
      max-lifetime: ${HIKARI_MAX_LIFETIME:1800000} # 30 minutes
      leak-detection-threshold: ${HIKARI_LEAK_DETECTION:60000} # 60 seconds (0 to disable)
      
      # Connection validation
      connection-test-query: "SELECT 1"
      validation-timeout: ${HIKARI_VALIDATION_TIMEOUT:5000} # 5 seconds
      
      # Performance tuning
      auto-commit: false # Let transactions control commit
      read-only: false
      
      # PostgreSQL-specific optimizations
      data-source-properties:
        # Connection pool name for monitoring
        applicationName: ${micronaut.application.name:neotool-service}
        # Connection parameters
        socketTimeout: 30
        loginTimeout: 10
        # Performance hints
        prepareThreshold: 0 # Disable prepared statement caching (let Hibernate handle it)
        tcpKeepAlive: true
        # SSL (configure for production)
        # ssl: true
        # sslmode: require

jpa:
  default:
    properties:
      hibernate:
        hbm2ddl:
          auto: none

flyway:
  datasources:
    default:
      enabled: true
      baseline-on-migrate: true
      baseline-version: 0
      table: flyway_schema_history_security
      schemas:
        - public
        - security

# Management Endpoints Configuration
endpoints:
  all:
    enabled: true
  health:
    enabled: true
    sensitive: false
  prometheus:
    enabled: true
    sensitive: false
  metrics:
    enabled: true
    sensitive: false
